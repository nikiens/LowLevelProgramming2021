\include{settings}

\begin{document}	% начало документа

% Титульная страница
\include{titlepage}

% Содержание
\include{ToC}

\section{Формулировка задания}
\begin{enumerate}
\item Разработать программу на языке ассемблера RISC-V, реализующую определенную вариантом задания функциональность, отладить программу в симуляторе VSim/Jupiter. Массив (массивы) данных и другие параметры (преобразуемое число, длина массива, параметр статистики и пр.) располагаются в памяти по фиксированным адресам.
\item Выделить определенную вариантом задания функциональность в подпрограмму, организованную в соответствии с ABI, разработать использующую ее тестовую программу. Адрес обрабатываемого массива данных и другие значения передавать через параметры подпрограммы в соответствии с ABI. Тестовая программа должна состоять из инициализирующего кода, кода завершения, подпрограммы main и тестируемой подпрограммы.
\end{enumerate}

\subsection{ Формулировка варианта задания}
Интегрирование табличной функции методом трапеций с «длинным» результатом.
\textit{Примечание: переполнение разрядной сетки предотвращается пользователем масштабированием параметра шага сетки.}

\[ \int_{a}^{b} f(x) \,dx = \sum_{i=0}^{n-1} \frac{f(x_i) + f(x_{i+1})}{2}(x_{i+1}-x_i) \]

\section{Организация программы}
\subsection{Входные и выходные данные}
Входными данными для программы являются 
\begin{enumerate}
\item  Длина массивов X и Y, записанное в форме 32 битного двоичного слова (word). Записывается в регистр a5 и используется в дальнейшем как счетчик итераций. 
\item Адреса массивов X и Y, записанные в форме 32 битного двоичного слова (word). Записываются в регистры a3 и a4 соответственно и используются в дальнейшем для указания адреса i-го элемента.
\item Элементы массивов X и Y хранятся в памяти в формате с плавающей запятой одинарной точности. 
\end{enumerate}

Выходным значением программы является значение определенного интеграла, полученное относительно X и Y. Записывается в регистр fa4.

Регулировка шага сетки предполагается модификацией значений X.

\subsection{Алгоритм работы программы}
На старте программы загружаются адреса массивов X и Y в регистры a3 и a4. Кроме этого загружается адрес, содержащий двойку, используемую при делении. Необходимость хранить 2 в памяти вызвана отсутствием аналога псевдоинструкии \textit{li} для чисел в формате с плавающей запятой.

На этом месте можно оптимизировать программу - достаточно хранить адрес divisor и обращаться к остальным элементам .rodata через него, но это непрактично из-за необходимости расчета положения элементов относиельно divisor.

Далее происходит загрузка счетчика в регистр a5, декрементируется на единицу для формирования значения n - 1 и загружается 2 в регистр fa0.

На следующем этапе в цикле просчитывается значение слагаемого. Рабочими регистрами являются fa1 и fa2, где хранятся значения сначала $x_{i+1}$ и $x_i$, а затем $y_{i+1}$ и $y_i$. Промежуточное значение ($x_{i+1}$ - $x_i$) хранится в регистре fa3, а ($y_{i+1}$ - $y_i$) - в fa1. Значение полученного слагаемого складывается с предыдущим из регистра fa4 и записывается туда же.

В конце декрементируется счетчик, и инкрементируется адреса массивов для перехода к следующим элементам. Цикл повторяется, пока не обнулиться счетчик.

\subsection{Код программы}
\lstinputlisting[
	label=code:hello,
	caption={trapz.s},% для печати символ '_' требует выходной символ '\'
]{trapz.s}
\parindent=1cm % командна \lstinputlisting сбивает параментры отступа

\section{Организация подпрограммы}
Далее нам потребуется написать подпрограмму main, реализовав в ней функциональность тестовой программы. В то же время, код, обеспечивающий вызов main и завершение работы, может использоваться «как есть» в самых разных программах. Учитывая это, мы разобьем текст программы на 2 файла: setup.s и main.s.

\lstinputlisting[
	label=code:hello,
	caption={subprog/setup.s},% для печати символ '_' требует выходной символ '\'
]{subprog/setup.s}

\lstinputlisting[
	label=code:hello,
	caption={subprog/main.s},% для печати символ '_' требует выходной символ '\'
]{subprog/main.s}

Подпрограмма main содержит входные данные:длина массивов X и Y и их адреса и элементы. Согласно ABI входные данные должны записываться в регистры аргументов: длина - в a2, адресс массива X - в а0, Y - в а1.

Исходное значение ra следует сохраняется перед псевдоинструкцией call, и восстанавлиается перед псевдоинструкцией ret. Это необходимо для избежания зацикливания программы, т.к иначе значение ra изменяется в результате выполнения псевдоинструкции call: в ra будет записан адрес возврата для вызываемой подпрограммы trapz, то есть адрес следующей за call псевдоинструкции, в данном случае - инструкции возврата из подпрограммы main. Таким образом, результатом выполнения инструкции возврата, соответствующе псевдоинструкции ret, будет переход на эту же инструкцию.

Рабочими регистрами подпрограммы trapz.s являются \textit{temporary} регистры ft0 и ft1 для хранения $x_{i+1}$ и $x_i$, а затем $y_{i+1}$ и $y_i$. Промежуточное значение ($x_{i+1}$ - $x_i$) хранится в регистре ft3, а ($y_{i+1}$ - $y_i$) - в ft0. Значение полученного слагаемого складывается с предыдущим из регистра ft4 и записывается туда же. Двойка хранится в ft5.

Результат работы записывается в регистр fa0.

\lstinputlisting[
	label=code:hello,
	caption={subprog/trapz.s},% для печати символ '_' требует выходной символ '\'
]{subprog/trapz.s}

\section{Выводы}
В ходе выполнения лабораторной работы была разработана программа на языке ассемблера RISC-V, выполняющая расчет значения определенного интеграла методом трапеций. Так же была создана тестовая программа, вызывающая подпрограмму, работающую с загруженными в нее данными о длине массивов и их адресами.
\end{document}
